<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    </head>
<body>
    <script>
        // --- FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyAltzbYKC1gTOoysYmCwb5_2_xYPQJglfI",
            authDomain: "chatbot-ai-7e89e.firebaseapp.com",
            projectId: "chatbot-ai-7e89e",
            storageBucket: "chatbot-ai-7e89e.firebasestorage.app",
            messagingSenderId: "381525150560",
            appId: "1:381525150560:web:a03a5f85bac184236d6c05",
            measurementId: "G-2PFEW30KN6"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore(); // Initialize Firestore

        // --- DOM ELEMENTS --- (from before)

        // --- AUTH STATE LISTENER ---
        auth.onAuthStateChanged(user => {
            if (user) {
                authContainer.classList.add('hidden');
                mainApp.classList.remove('hidden');
                loadChatHistory(); // Load history on login
            } else {
                authContainer.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }
        });

        // --- NEW: Function to load history ---
        async function loadChatHistory() {
            chatbox.innerHTML = ''; // Clear the chatbox first
            const token = await auth.currentUser.getIdToken();
            try {
                const response = await fetch('/get-history', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.history) {
                    data.history.forEach(msg => {
                        const className = msg.role === 'user' ? 'user-message' : 'bot-message';
                        const messageDiv = appendMessage(msg.text, className);
                        if (className === 'bot-message') {
                            addCopyButton(messageDiv);
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to load history:', error);
            }
        }
        
        // --- UPDATED: sendMessage function ---
        async function sendMessage(messageText) {
            if (!messageText || messageText.trim() === '') return;
            appendMessage(messageText, 'user-message');
            userInput.value = '';
            
            const token = await auth.currentUser.getIdToken(); // Get auth token

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // Send token for verification
                    },
                    body: JSON.stringify({ message: messageText })
                });
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const data = await response.json();
                
                const botMessageDiv = appendMessage(data.response, 'bot-message');
                addCopyButton(botMessageDiv);
            } catch (error) {
                appendMessage("Oops! Something went wrong.", 'bot-message');
                console.error("Error:", error);
            }
        }

        function appendMessage(text, className) {
            // ... same appendMessage function as before ...
        }
        function addCopyButton(botMessageElement) {
            // ... same addCopyButton function as before ...
        }

        // --- UPDATED: newChatBtn listener ---
        newChatBtn.addEventListener('click', async () => {
            const token = await auth.currentUser.getIdToken();
            await fetch('/new-chat', { headers: { 'Authorization': `Bearer ${token}` } });
            chatbox.innerHTML = ''; // Visually clear the chat
        });
        
        // ... all other listeners and functions from before ...
    </script>
</body>
</html>